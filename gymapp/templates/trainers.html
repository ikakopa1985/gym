{% extends "base.html" %}
{% block title %}áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ”áƒ‘áƒ˜ â€¢ Gym Manager{% endblock %}
{% block nav_trainers_active %}active{% endblock %}

{% block extra_css %}
<style>
  .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .tableWrap{
    margin-top:12px;
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
    background: var(--field-bg);
  }
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{
    text-align:left;
    padding:12px 12px;
    font-weight:900;
    background: rgba(255,255,255,.03);
    border-bottom:1px solid var(--line);
    position:sticky; top:0;
  }
  tbody td{
    padding:12px 12px;
    border-bottom:1px solid rgba(255,255,255,.06);
    vertical-align:middle;
  }
  tbody tr:hover{ background: rgba(38,153,165,.08); }
  .tdActions{white-space:nowrap; display:flex; gap:8px; align-items:center;}
  .kv{
    display:grid;
    grid-template-columns: 180px 1fr;
    gap:10px 14px;
    font-size:13px;
  }
  .kv label{color:var(--muted);font-weight:900}
  .input{
    width:100%;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line2);
    background: var(--field-bg);
    color:var(--text);
    outline:0;
  }
  @media (max-width: 760px){
    .kv{grid-template-columns:1fr}
  }
</style>
{% endblock %}

{% block content %}
<div class="grid">

  <div class="card">
    <div class="head">
      <div>
        <h2>áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ”áƒ‘áƒ˜</h2>
        <div class="sub">áƒ¡áƒ˜áƒ â€¢ áƒ«áƒ”áƒ‘áƒœáƒ â€¢ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</div>
      </div>

      <div class="row">
        <span class="pill" id="countPill">0 áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ˜</span>
        <button class="btn primary" id="btnOpenNew" type="button">+ áƒáƒ®áƒáƒšáƒ˜ áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ˜</button>
      </div>
    </div>

    <div class="body">
      <div class="row">
        <div class="field" style="flex:1;min-width:260px;">
          <span>ğŸ”</span>
          <input id="q" placeholder="áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ / áƒ’áƒ•áƒáƒ áƒ˜ / áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜ / áƒ¡áƒáƒ”áƒªáƒ˜áƒáƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ" autocomplete="off">
        </div>
        <button class="btn primary" id="btnSearch" type="button">áƒ«áƒ”áƒ‘áƒœáƒ</button>
        <button class="btn" id="btnReset" type="button">áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</button>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:26%">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒ’áƒ•áƒáƒ áƒ˜</th>
              <th style="width:18%">áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜</th>
              <th style="width:30%">áƒ¡áƒáƒ”áƒªáƒ˜áƒáƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ</th>
              <th style="width:12%">Fee (â‚¾)</th>
              <th style="width:14%">áƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- New Trainer Modal -->
<div class="modalOverlay" id="overlayNew">
  <div class="modal">
    <div class="mhead">
      <strong>áƒáƒ®áƒáƒšáƒ˜ áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ˜</strong>
      <button class="closeX" id="closeNew" type="button">âœ•</button>
    </div>
    <div class="mbody">
      <div class="kv">
        <label>áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ *</label>
        <input class="input" id="t_first" placeholder="áƒœáƒ˜áƒ™áƒ">

        <label>áƒ’áƒ•áƒáƒ áƒ˜ *</label>
        <input class="input" id="t_last" placeholder="áƒ‘áƒ”áƒ áƒ˜áƒ«áƒ”">

        <label>áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜ *</label>
        <input class="input" id="t_phone" placeholder="555123456">

        <label>áƒ¡áƒáƒ”áƒªáƒ˜áƒáƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ</label>
        <input class="input" id="t_spec" placeholder="áƒ™áƒáƒ áƒ“áƒ˜áƒ / áƒ¤áƒ˜áƒ¢áƒœáƒ”áƒ¡áƒ˜ / áƒ«áƒáƒšáƒáƒ•áƒáƒœáƒ˜...">

        <label>Fee (â‚¾) *</label>
        <input class="input" id="t_fee" type="number" step="0.01" min="0" placeholder="áƒ›áƒáƒ’: 30">
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn primary" id="btnSave" type="button">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        <button class="btn" id="btnCancel" type="button">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
      </div>
      <div class="hint">Fee áƒáƒ áƒ˜áƒ¡ áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ—áƒ˜ áƒ—áƒáƒœáƒ®áƒ, áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ”áƒ‘áƒ áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ¤áƒáƒ¡áƒ¡.</div>
    </div>
  </div>
</div>

<!-- View Modal -->
<div class="modalOverlay" id="overlayView">
  <div class="modal">
    <div class="mhead">
      <strong id="vTitle">áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ˜</strong>
      <button class="closeX" id="closeView" type="button">âœ•</button>
    </div>
    <div class="mbody" id="vBody"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

  const $ = (id)=>document.getElementById(id);

let editId = null;

const overlayNew = $("overlayNew");
const overlayView = $("overlayView");

function openNew(){
  editId = null;
  $("btnSave").textContent = "áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ";
  $("t_first").value = "";
  $("t_last").value = "";
  $("t_phone").value = "";
  $("t_spec").value = "";
  $("t_fee").value = "";
  overlayNew.classList.add("show");
}
function closeNew(){ overlayNew.classList.remove("show"); }
function openView(){ overlayView.classList.add("show"); }
function closeView(){ overlayView.classList.remove("show"); }

$("btnOpenNew").addEventListener("click", openNew);
$("closeNew").addEventListener("click", closeNew);
$("btnCancel").addEventListener("click", closeNew);
overlayNew.addEventListener("click", (e)=>{ if(e.target===overlayNew) closeNew(); });

$("closeView").addEventListener("click", closeView);
overlayView.addEventListener("click", (e)=>{ if(e.target===overlayView) closeView(); });

function fmtFee(v){
  const n = Number(v ?? 0);
  return Number.isFinite(n) ? n.toFixed(2) : "0.00";
}

function renderRows(items){
  const tbody = $("tbody");
  tbody.innerHTML = "";
  $("countPill").textContent = `${items.length} áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ˜`;

  for(const t of items){
    const full = `${t.first_name || ""} ${t.last_name || ""}`.trim();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div style="font-weight:900">${full || "â€”"}</div>
        <div class="muted" style="font-size:12px;margin-top:3px;">ID: ${t.id}</div>
      </td>
      <td>${t.phone || "â€”"}</td>
      <td>${t.specialization || "â€”"}</td>
      <td style="font-weight:900">${fmtFee(t.fee)}â‚¾</td>
      <td>
        <div class="tdActions">
          <button class="btn" data-view="${t.id}" type="button">ğŸ‘ï¸ áƒœáƒáƒ®áƒ•áƒ</button>
          <button class="btn" data-edit="${t.id}" type="button">âœï¸ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ</button>
          <button class="btn danger" data-del="${t.id}" type="button">ğŸ—‘ï¸ áƒ¬áƒáƒ¨áƒšáƒ</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll("[data-view]").forEach(btn=>{
    btn.addEventListener("click", ()=> viewTrainer(Number(btn.dataset.view)));
  });
  tbody.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=> editTrainer(Number(btn.dataset.edit)));
  });
  tbody.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=> deleteTrainer(Number(btn.dataset.del)));
  });
}

async function loadTrainers(q=""){
  const url = q ? `/api/trainers/?search=${encodeURIComponent(q)}` : "/api/trainers/";
  const res = await fetch(url);
  if(!res.ok){
    toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ›áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
    return;
  }
  const data = await res.json();
  renderRows(data);
}

async function editTrainer(id){
  const res = await fetch(`/api/trainers/${id}/`);
  if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ•áƒ”áƒ  áƒ’áƒáƒ˜áƒ®áƒ¡áƒœáƒ"); return; }
  const t = await res.json();

  editId = id;
  $("t_first").value = t.first_name || "";
  $("t_last").value  = t.last_name || "";
  $("t_phone").value = t.phone || "";
  $("t_spec").value  = t.specialization || "";
  $("t_fee").value   = Number(t.fee ?? 0);

  $("btnSave").textContent = "áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ";
  overlayNew.classList.add("show");
}

async function deleteTrainer(id){
  if(!confirm("áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ˜áƒœáƒ“áƒ áƒ¬áƒáƒ¨áƒšáƒ?")) return;

  const res = await fetch(`/api/trainers/${id}/`, {
    method: "DELETE",
    headers: {"X-CSRFToken": csrftoken}
  });

  if(!res.ok){
    toast("bad","áƒ•áƒ”áƒ  áƒ¬áƒáƒ˜áƒ¨áƒáƒšáƒ","áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜ áƒ’áƒáƒ›áƒáƒ§áƒ”áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜áƒ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ¨áƒ˜.");
    return;
  }
  toast("ok","OK","áƒ¬áƒáƒ˜áƒ¨áƒáƒšáƒ âœ…");
  await loadTrainers($("q").value.trim());
}

async function viewTrainer(id){
  const res = await fetch(`/api/trainers/${id}/`);
  if(!res.ok){
    toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ›áƒ¬áƒ•áƒ áƒ—áƒœáƒ”áƒšáƒ˜áƒ¡ áƒ’áƒáƒ®áƒ¡áƒœáƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
    return;
  }
  const t = await res.json();
  $("vTitle").textContent = `${t.first_name} ${t.last_name}`.trim();
  $("vBody").innerHTML = `
    <div class="kv">
      <label>ID</label><div>${t.id}</div>
      <label>áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label><div>${t.first_name || "â€”"}</div>
      <label>áƒ’áƒ•áƒáƒ áƒ˜</label><div>${t.last_name || "â€”"}</div>
      <label>áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜</label><div>${t.phone || "â€”"}</div>
      <label>áƒ¡áƒáƒ”áƒªáƒ˜áƒáƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ</label><div>${t.specialization || "â€”"}</div>
      <label>Fee (â‚¾)</label><div style="font-weight:900">${fmtFee(t.fee)}â‚¾</div>
    </div>
  `;
  openView();
}

$("btnSearch").addEventListener("click", ()=> loadTrainers($("q").value.trim()));
$("btnReset").addEventListener("click", ()=> { $("q").value=""; loadTrainers(""); });
$("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadTrainers($("q").value.trim()); });

$("btnSave").addEventListener("click", async ()=>{
  const first_name = $("t_first").value.trim();
  const last_name  = $("t_last").value.trim();
  const phone      = $("t_phone").value.trim();
  const specialization = $("t_spec").value.trim();
  const feeRaw = $("t_fee").value;

  const fee = feeRaw === "" ? null : Number(feeRaw);

  if(!first_name || !last_name || !phone){
    toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”: áƒ¡áƒáƒ®áƒ”áƒšáƒ˜, áƒ’áƒ•áƒáƒ áƒ˜, áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜.");
    return;
  }
  if(fee === null || !Number.isFinite(fee) || fee < 0){
    toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","Fee áƒ›áƒ˜áƒ£áƒ—áƒ˜áƒ—áƒ” áƒ¡áƒ¬áƒáƒ áƒáƒ“ (0 áƒáƒœ áƒ›áƒ”áƒ¢áƒ˜).");
    return;
  }

  const payload = { first_name, last_name, phone, specialization, fee };

  const url = editId ? `/api/trainers/${editId}/` : "/api/trainers/";
  const methodHttp = editId ? "PATCH" : "POST";

  const res = await fetch(url, {
    method: methodHttp,
    headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    let err = {};
    try{ err = await res.json(); }catch(e){}
    toast("bad","áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ˜áƒœáƒáƒ®áƒ", err.detail || JSON.stringify(err) || "áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ” áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜.");
    return;
  }

  toast("ok","OK", editId ? "áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ âœ…" : "áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ âœ…");
  closeNew();
  editId = null;
  await loadTrainers($("q").value.trim());
});

// init
loadTrainers("");


</script>
{% endblock %}
