{% extends "base.html" %}
{% block title %}áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ â€¢ Gym Manager{% endblock %}
{% block nav_memberships_active %}active{% endblock %}

{% block extra_css %}
<style>
  .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .tableWrap{margin-top:12px;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--field-bg);}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{padding:12px 12px;font-weight:900;background:rgba(255,255,255,.03);border-bottom:1px solid var(--line);position:sticky;top:0;}
  tbody td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
  tbody tr:hover{background:rgba(38,153,165,.08)}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:10px 14px;font-size:13px;}
  .kv label{color:var(--muted);font-weight:900}
  .input{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line2);background:var(--field-bg);color:var(--text);outline:0;}
</style>
{% endblock %}

{% block content %}
<div class="grid">
  <div class="card">
    <div class="head">
      <div>
        <h2>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜</h2>
        <div class="sub">áƒ’áƒ”áƒ’áƒ›áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ (unlimited/limited/fixed)</div>
      </div>
      <div class="row">
        <span class="pill" id="countPill">0</span>
        <button class="btn primary" id="btnOpenNew">+ áƒáƒ®áƒáƒšáƒ˜ áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</button>
      </div>
    </div>

    <div class="body">
      <div class="row">
        <div class="field" style="flex:1;min-width:260px;">
          <span>ğŸ”</span>
          <input id="q" placeholder="áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ / áƒ¢áƒ˜áƒáƒ˜" autocomplete="off">
        </div>
        <button class="btn primary" id="btnSearch">áƒ«áƒ”áƒ‘áƒœáƒ</button>
        <button class="btn" id="btnReset">áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</button>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:28%">áƒ“áƒáƒ¡áƒáƒ®áƒ”áƒšáƒ”áƒ‘áƒ</th>
              <th style="width:18%">áƒ¢áƒ˜áƒáƒ˜</th>
              <th style="width:18%">áƒ¤áƒáƒ¡áƒ˜</th>
              <th style="width:18%">duration_days</th>
              <th style="width:18%">visit_count</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modalOverlay" id="overlayNew">
  <div class="modal">
    <div class="mhead">
      <strong>áƒáƒ®áƒáƒšáƒ˜ áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</strong>
      <button class="closeX" id="closeNew">âœ•</button>
    </div>
    <div class="mbody">
      <div class="kv">
        <label>áƒ“áƒáƒ¡áƒáƒ®áƒ”áƒšáƒ”áƒ‘áƒ *</label>
        <input class="input" id="m_name" placeholder="Unlimited 1 áƒ—áƒ•áƒ”">

        <label>áƒ¢áƒ˜áƒáƒ˜ *</label>
        <select class="input" id="m_type">
          <option value="unlimited">áƒ£áƒšáƒ˜áƒ›áƒ˜áƒ¢áƒ (áƒ“áƒ¦áƒ”áƒ”áƒ‘áƒ˜áƒ—)</option>
          <option value="limited">áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ áƒ˜áƒ•áƒ˜ (áƒ•áƒ˜áƒ–áƒ˜áƒ¢áƒ”áƒ‘áƒ˜áƒ—)</option>
          <option value="fixed">áƒ“áƒ áƒáƒ˜áƒ—áƒ˜ (áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜áƒ“áƒáƒœ-áƒ—áƒáƒ áƒ˜áƒ¦áƒáƒ›áƒ“áƒ”)</option>
        </select>

        <label>áƒ¤áƒáƒ¡áƒ˜ *</label>
        <input class="input" id="m_price" type="number" step="0.01" placeholder="120">

        <label>duration_days (unlimited)</label>
        <input class="input" id="m_days" type="number" placeholder="30">

        <label>visit_count (limited)</label>
        <input class="input" id="m_visits" type="number" placeholder="10">
      </div>

      <div class="hint">fixed áƒ¢áƒ˜áƒáƒ¡ duration/visits áƒáƒ  áƒ¡áƒ­áƒ˜áƒ áƒ“áƒ”áƒ‘áƒ â€” áƒ—áƒáƒ áƒ˜áƒ¦áƒ”áƒ‘áƒ¡ Payment-áƒ–áƒ” áƒ›áƒ˜áƒ£áƒ—áƒ˜áƒ—áƒ”áƒ‘.</div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="btnSave">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        <button class="btn" id="btnCancel">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const $ = (id)=>document.getElementById(id);
  const overlayNew = $("overlayNew");

  function openNew(){ overlayNew.classList.add("show"); }
  function closeNew(){ overlayNew.classList.remove("show"); }

  $("btnOpenNew").addEventListener("click", openNew);
  $("closeNew").addEventListener("click", closeNew);
  $("btnCancel").addEventListener("click", closeNew);
  overlayNew.addEventListener("click", (e)=>{ if(e.target===overlayNew) closeNew(); });

  function renderRows(items){
    $("countPill").textContent = `${items.length} áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜`;
    const tbody = $("tbody");
    tbody.innerHTML = "";
    items.forEach(m=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-weight:900">${m.name}</td>
        <td>${m.membership_type}</td>
        <td>${m.price}â‚¾</td>
        <td>${m.duration_days ?? "â€”"}</td>
        <td>${m.visit_count ?? "â€”"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function loadMemberships(q=""){
    const url = q ? `/api/memberships/?search=${encodeURIComponent(q)}` : "/api/memberships/";
    const res = await fetch(url);
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    const data = await res.json();
    renderRows(data);
  }

  $("btnSearch").addEventListener("click", ()=> loadMemberships($("q").value.trim()));
  $("btnReset").addEventListener("click", ()=>{ $("q").value=""; loadMemberships(""); });
  $("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadMemberships($("q").value.trim()); });

  $("btnSave").addEventListener("click", async ()=>{
    const name = $("m_name").value.trim();
    const membership_type = $("m_type").value;
    const price = $("m_price").value;

    if(!name || !price){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”: áƒ“áƒáƒ¡áƒáƒ®áƒ”áƒšáƒ”áƒ‘áƒ áƒ“áƒ áƒ¤áƒáƒ¡áƒ˜"); return;
    }

    const payload = {
      name,
      membership_type,
      price,
      duration_days: $("m_days").value ? Number($("m_days").value) : null,
      visit_count: $("m_visits").value ? Number($("m_visits").value) : null,
    };

    const res = await fetch("/api/memberships/", {
      method:"POST",
      headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      let err={}; try{ err=await res.json(); }catch(e){}
      toast("bad","áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ˜áƒœáƒáƒ®áƒ", err.detail || JSON.stringify(err)); return;
    }

    toast("ok","áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ","áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜ áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ âœ…");
    closeNew();
    $("m_name").value=""; $("m_price").value=""; $("m_days").value=""; $("m_visits").value="";
    await loadMemberships($("q").value.trim());
  });

  loadMemberships("");
</script>
{% endblock %}
