{% extends "base.html" %}
{% block title %}áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ â€¢ Gym Manager{% endblock %}
{% block nav_home_active %}active{% endblock %}

{% block extra_css %}
<style>
  .grid{
    display:grid;
    grid-template-columns: 1.6fr .9fr;
    gap:16px;
    margin-top:16px;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }

  .searchRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .field{flex:1;min-width:240px}
  .tableWrap{
    margin-top:12px;
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
    background: var(--field-bg);
  }
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{
    text-align:left;
    padding:12px 12px;
    color: #cfe9ee;
    font-weight:900;
    background: rgba(255,255,255,.03);
    border-bottom:1px solid var(--line);
    position:sticky; top:0;
  }
  html[data-theme="light"] thead th{ color: var(--text); }

  tbody td{
    padding:12px 12px;
    border-bottom:1px solid rgba(255,255,255,.06);
    vertical-align:middle;
  }
  tbody tr:hover{ background: rgba(38,153,165,.08); }
  .tdActions{white-space:nowrap; display:flex; gap:8px; align-items:center;}


  .stats{display:grid;gap:12px;}
  .stat{
    padding:14px 14px;
    border:1px solid var(--line);
    border-radius:var(--radius);
    background: var(--field-bg);
  }
  .stat .k{font-size:12px;color:var(--muted);font-weight:900}
  .stat .v{font-size:22px;font-weight:900;margin-top:6px}
  .stat .s{font-size:12px;color:var(--muted);margin-top:4px}
  .mini{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .mini .chip{
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:999px;
    padding:8px 10px;
    font-size:12px;
    font-weight:900;
  }

  .pill.ok{background:rgba(46,204,113,.12);border:1px solid rgba(46,204,113,.35);color:#bff3cf}
  .pill.bad{background:rgba(255,111,89,.12);border:1px solid rgba(255,111,89,.35);color:#ffd2cc}

  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

  /* Payments modal table */
  .modalTableWrap{
    margin-top:12px;
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    background: var(--field-bg);
    max-height: 340px;
    overflow:auto;
  }
  .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
</style>
{% endblock %}

{% block content %}
  <div class="grid">

    <!-- Left: Clients -->
    <div class="card">
      <div class="head">
        <div>
          <h2>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ˜áƒ</h2>
          <div class="sub">áƒ«áƒ”áƒ‘áƒœáƒ áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜áƒ—, áƒ¡áƒáƒ®áƒ”áƒšáƒ˜áƒ— áƒáƒœ áƒ’áƒ•áƒáƒ áƒ˜áƒ— â€¢ Check-in áƒ•áƒáƒ“áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ˜áƒ—</div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <button class="btn primary" id="btnNewClient" type="button">+ áƒáƒ®áƒáƒšáƒ˜ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</button>
          <button class="btn" id="btnNewPayment" type="button">ğŸ’³ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</button>
          <div class="pill" id="clientsCountPill">0 áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</div>
        </div>
      </div>

      <div class="body">
        <div class="searchRow">
          <div class="field">
            <span>ğŸ”</span>
            <input id="q" placeholder="áƒ›áƒáƒ’: 555123456 áƒáƒœ 'áƒ’áƒ˜áƒáƒ áƒ’áƒ˜'..." autocomplete="off" />
          </div>
          <button class="btn primary" id="btnSearch" type="button">áƒ«áƒ”áƒ‘áƒœáƒ</button>
          <button class="btn" id="btnReset" type="button">áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</button>
        </div>

        <div class="hint">Enter-áƒ–áƒ” áƒ“áƒáƒ­áƒ”áƒ áƒáƒª áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡. Check-in áƒ‘áƒšáƒáƒ™áƒáƒ•áƒ¡ áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ¡.</div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:28%">áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</th>
                <th style="width:18%">áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜</th>
                <th style="width:22%">áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</th>
                <th style="width:18%">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</th>
                <th style="width:14%">áƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right: Stats -->
    <div class="stats">
      <div class="card">
        <div class="head">
          <div>
            <h2>áƒ“áƒ¦áƒ˜áƒ£áƒ áƒ˜ áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ</h2>
            <div class="sub">Reports API</div>
          </div>
        </div>
        <div class="body">
          <div class="stat">
            <div class="k">áƒ“áƒ¦áƒ”áƒ¡ áƒ¨áƒ”áƒ›áƒáƒ¡áƒ£áƒšáƒ˜ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜</div>
            <div class="v" id="statTodayCheckins">0</div>
            <div class="s">Check-in áƒ©áƒáƒœáƒáƒ¬áƒ”áƒ áƒ”áƒ‘áƒ˜</div>
          </div>

          <div class="mini">
            <div class="chip" id="chipActive">áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜: 0</div>
            <div class="chip" id="chipExpired">áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ˜: 0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <h2>áƒ¤áƒ˜áƒœáƒáƒœáƒ¡áƒ”áƒ‘áƒ˜</h2>
            <div class="sub">Reports API</div>
          </div>
        </div>
        <div class="body">
          <div class="stat">
            <div class="k">áƒ“áƒ¦áƒ˜áƒ£áƒ áƒ˜ áƒ¨áƒ”áƒ›áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜</div>
            <div class="v" id="statTodayIncome">0â‚¾</div>
            <div class="s">Payment-áƒ˜áƒ¡ áƒ¯áƒáƒ›áƒ˜</div>
          </div>
          <div class="stat" style="margin-top:12px">
            <div class="k">áƒ—áƒ•áƒ˜áƒ£áƒ áƒ˜ áƒ¨áƒ”áƒ›áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜</div>
            <div class="v" id="statMonthIncome">0â‚¾</div>
            <div class="s">Payment-áƒ˜áƒ¡ áƒ¯áƒáƒ›áƒ˜</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <h2>áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ”áƒ‘áƒ˜</h2>
            <div class="sub">MVP</div>
          </div>
        </div>
        <div class="body">
          <button class="btn primary" style="width:100%; justify-content:center" id="btnQuickCheckin" type="button">
            âœ… áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ Check-in (áƒáƒ áƒ©áƒ”áƒ£áƒšáƒ–áƒ”)
          </button>
          <button class="btn" style="width:100%; justify-content:center; margin-top:10px" id="btnRefresh" type="button">
            ğŸ”„ áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ
          </button>
          <button class="btn danger" style="width:100%; justify-content:center; margin-top:10px" id="btnExpiredList" type="button">
            â›” áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒœáƒáƒ®áƒ•áƒ
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- Client Modal -->
  <div class="modalOverlay" id="overlay">
    <div class="modal">
      <div class="mhead">
        <strong id="mTitle">áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜</strong>
        <button class="closeX" id="mClose" type="button">âœ•</button>
      </div>
      <div class="mbody">
        <div class="kv" id="mKV" style="display:grid;grid-template-columns:180px 1fr;gap:10px 14px;font-size:13px;"></div>
        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn primary" id="mCheckin" type="button">âœ… Check-in</button>
          <button class="btn" id="mPayment" type="button">ğŸ’³ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</button>
          <button class="btn" id="mPayHistory" type="button">ğŸ“œ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ</button>
          <button class="btn" id="mEdit" type="button">âœï¸ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payments History Modal (same function as payments page details) -->
  <div class="modalOverlay" id="overlayPayHistory">
    <div class="modal" style="max-width:980px;">
      <div class="mhead">
        <strong id="phTitle">áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ</strong>
        <button class="closeX" id="phClose" type="button">âœ•</button>
      </div>
      <div class="mbody">
        <div class="kv" id="phKV"></div>

        <div class="divider"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:900">áƒ§áƒ•áƒ”áƒšáƒ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</div>
            <div class="muted" style="font-size:12px;margin-top:2px" id="phSub">â€”</div>
          </div>
          <div class="muted" style="font-size:12px">
            áƒ¯áƒáƒ›áƒ˜: <span class="mono" id="phSum">0.00â‚¾</span>
          </div>
        </div>

        <div class="modalTableWrap">
          <table>
            <thead>
              <tr>
                <th>áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜</th>
                <th>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜</th>
                <th>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</th>
                <th>Fixed</th>
                <th>áƒáƒ‘áƒáƒœ(â‚¾)</th>
                <th>áƒ¢áƒ áƒ”áƒœ(â‚¾)</th>
                <th>áƒ¡áƒ£áƒš(â‚¾)</th>
                <th>áƒ›áƒ”áƒ—áƒáƒ“áƒ˜</th>
              </tr>
            </thead>
            <tbody id="phTbody"></tbody>
          </table>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="phGoPayments" type="button">áƒ’áƒáƒ“áƒáƒ¡áƒ•áƒšáƒ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ–áƒ”</button>
          <button class="btn primary" id="phClose2" type="button">áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  const $ = (id) => document.getElementById(id);

  let clientsCache = [];
  let paymentsCache = [];
  let selectedClientId = null;
  let onlyExpiredMode = false;

  function fmtMoney(v){
    const n = Number(v ?? 0);
    return Number.isFinite(n) ? n.toFixed(2) : "0.00";
  }
  function fmtDT(iso){
    if(!iso) return "â€”";
    return String(iso).slice(0,19).replace("T"," ");
  }

  function pillStatus(isActive){
    return isActive
      ? `<span class="pill ok">âœ… áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜</span>`
      : `<span class="pill bad">â›” áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ˜áƒ</span>`;
  }

  function membershipText(c){
    if(!c.active_membership_id) return `<span class="muted">â€”</span>`;
    return `áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜ <div class="muted" style="font-size:12px;margin-top:3px;">ID: ${c.active_membership_id}</div>`;
  }

  function renderClients(list){
    const tbody = $("tbody");
    tbody.innerHTML = "";

    list.forEach(c => {
      const full = `${c.first_name || ""} ${c.last_name || ""}`.trim();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="font-weight:900">${full || "â€”"}</div>
          <div class="muted" style="font-size:12px;margin-top:3px;">ID: ${c.id}</div>
        </td>
        <td>${c.phone || "â€”"}</td>
        <td>${membershipText(c)}</td>
        <td>${pillStatus(!!c.is_active)}</td>
        <td>
          <div class="tdActions">
            <button class="btn primary" data-checkin="${c.id}" type="button">âœ… Check-in</button>
            <button class="btn" data-view="${c.id}" type="button">ğŸ‘ï¸ áƒœáƒáƒ®áƒ•áƒ</button>
            <button class="btn" data-history="${c.id}" type="button">ğŸ“œ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    $("clientsCountPill").textContent = `${list.length} áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜`;

    const activeCount = list.filter(x => !!x.is_active).length;
    const expiredCount = list.length - activeCount;
    $("chipActive").textContent = `áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜: ${activeCount}`;
    $("chipExpired").textContent = `áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ˜: ${expiredCount}`;

    tbody.querySelectorAll("[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=> openClientModal(Number(btn.dataset.view)));
    });
    tbody.querySelectorAll("[data-checkin]").forEach(btn=>{
      btn.addEventListener("click", ()=> doCheckinByClientId(Number(btn.dataset.checkin)));
    });
    tbody.querySelectorAll("[data-history]").forEach(btn=>{
      btn.addEventListener("click", ()=> openPayHistoryByClientId(Number(btn.dataset.history)));
    });
  }

  function applySearch(){
    const q = ($("q").value || "").trim().toLowerCase();
    let list = clientsCache.slice();

    if(q){
      list = list.filter(c=>{
        const full = `${c.first_name || ""} ${c.last_name || ""}`.toLowerCase();
        return full.includes(q) || String(c.phone || "").includes(q);
      });
    }
    if(onlyExpiredMode){
      list = list.filter(c => !c.is_active);
    }
    renderClients(list);
  }

  async function loadClients(){
    const res = await fetch("/api/clients/");
    if(!res.ok){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ");
      return;
    }
    clientsCache = await res.json();
    applySearch();
  }

  async function loadPayments(){
    const res = await fetch("/api/payments/");
    if(!res.ok){
      // áƒáƒ  áƒ•áƒáƒ‘áƒšáƒáƒ™áƒáƒ•áƒ— áƒ’áƒ•áƒ”áƒ áƒ“áƒ¡, áƒ›áƒáƒ’áƒ áƒáƒ› history áƒ•áƒ”áƒ  áƒ˜áƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ¡
      paymentsCache = [];
      return;
    }
    paymentsCache = await res.json();
  }

  async function loadSummary(){
    const res = await fetch("/api/reports/summary/");
    if(!res.ok) return;
    const s = await res.json();

    $("statTodayCheckins").textContent = Number(s.today_checkins || 0);
    $("statTodayIncome").textContent = `${Number(s.today_income || 0).toFixed(2)}â‚¾`;
    $("statMonthIncome").textContent = `${Number(s.month_income || 0).toFixed(2)}â‚¾`;

    $("chipActive").textContent = `áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜: ${Number(s.active_memberships || 0)}`;
    $("chipExpired").textContent = `áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ˜: ${Number(s.expired_memberships || 0)}`;
  }

  async function doCheckinByClientId(clientId){
    const res = await fetch("/api/checkins/", {
      method: "POST",
      headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
      body: JSON.stringify({ client: clientId })
    });

    let data = {};
    try{ data = await res.json(); }catch(e){}

    if(!res.ok){
      toast("bad","áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ", data.detail || "áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜ áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ˜áƒ áƒáƒœ áƒáƒ  áƒáƒ¥áƒ•áƒ¡ áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜");
      return;
    }

    toast("ok","OK","Check-in áƒ“áƒáƒ¤áƒ˜áƒ¥áƒ¡áƒ˜áƒ áƒ“áƒ âœ…");
    await loadClients();
    await loadPayments();
    await loadSummary();
  }

  async function doCheckinByPhone(phone){
    const res = await fetch("/api/checkins/quick/", {
      method: "POST",
      headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
      body: JSON.stringify({ phone })
    });

    let data = {};
    try{ data = await res.json(); }catch(e){}

    if(!res.ok){
      toast("bad","áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ", data.detail || "áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ / áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ˜áƒ");
      return;
    }

    toast("ok","OK","Check-in áƒ“áƒáƒ¤áƒ˜áƒ¥áƒ¡áƒ˜áƒ áƒ“áƒ âœ…");
    await loadClients();
    await loadPayments();
    await loadSummary();
  }

  // ===== Client modal
  function openClientModal(id){
    const c = clientsCache.find(x => Number(x.id) === Number(id));
    if(!c) return;
    selectedClientId = id;

    $("mTitle").textContent = `${c.first_name || ""} ${c.last_name || ""}`.trim();
    $("mKV").innerHTML = `
      <div>áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜</div><div>${c.phone || "â€”"}</div>
      <div>áƒ”áƒš.áƒ¤áƒáƒ¡áƒ¢áƒ</div><div>${c.email || "â€”"}</div>
      <div>áƒáƒ áƒ’áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ</div><div>${c.organization || "â€”"}</div>
      <div>áƒ‘áƒáƒ áƒáƒ—áƒ˜</div><div>${c.card_number || "â€”"}</div>
      <div>áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜ áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</div><div>${c.active_membership_id ? "ID: " + c.active_membership_id : "â€”"}</div>
      <div>áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</div><div>${c.is_active ? "áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜áƒ" : "áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ˜áƒ"}</div>
    `;
    $("overlay").classList.add("show");
  }

  function closeClientModal(){ $("overlay").classList.remove("show"); }

  $("mClose").addEventListener("click", closeClientModal);
  $("overlay").addEventListener("click", (e)=>{ if(e.target === $("overlay")) closeClientModal(); });

  $("mCheckin").addEventListener("click", ()=>{ if(selectedClientId) doCheckinByClientId(selectedClientId); });
  $("mPayment").addEventListener("click", ()=> { window.location.href = "/payments/"; });
  $("mEdit").addEventListener("click", ()=> { window.location.href = "/clients/"; });

  // ===== Payments history modal (same function)
  const overlayPayHistory = $("overlayPayHistory");

  function closePayHistory(){ overlayPayHistory.classList.remove("show"); }

  $("phClose").addEventListener("click", closePayHistory);
  $("phClose2").addEventListener("click", closePayHistory);
  overlayPayHistory.addEventListener("click", (e)=>{ if(e.target===overlayPayHistory) closePayHistory(); });

  $("phGoPayments").addEventListener("click", ()=>{ window.location.href = "/payments/"; });

  function openPayHistoryByClientId(clientId){
    const c = clientsCache.find(x => Number(x.id) === Number(clientId));
    const clientName = c ? `${c.first_name || ""} ${c.last_name || ""}`.trim() : `ID: ${clientId}`;

    const list = paymentsCache
      .filter(p => String(p.client) === String(clientId))
      .sort((a,b)=> Number(b.id) - Number(a.id));

    $("phTitle").textContent = `áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ â€¢ ${clientName}`;
    $("phKV").innerHTML = `
      <label>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</label><div>${clientName}</div>
      <label>áƒ©áƒáƒœáƒáƒ¬áƒ”áƒ áƒ”áƒ‘áƒ˜</label><div class="mono">${list.length}</div>
    `;

    $("phSub").textContent = `áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ§áƒ•áƒ”áƒšáƒ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ (áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜/áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜/áƒ¤áƒ˜áƒ¥áƒ¡áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒáƒ”áƒ áƒ˜áƒáƒ“áƒ˜/áƒ—áƒáƒœáƒ®áƒ”áƒ‘áƒ˜)`;

    const sum = list.reduce((acc, x)=> acc + Number(x.amount || 0), 0);
    $("phSum").textContent = `${fmtMoney(sum)}â‚¾`;

    const tb = $("phTbody");
    tb.innerHTML = "";
    list.forEach(x=>{
      const fixed = (x.fixed_start || x.fixed_end) ? `${x.fixed_start || "â€”"} â†’ ${x.fixed_end || "â€”"}` : "â€”";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtDT(x.created_at)}</td>
        <td>${x.trainer_name || "â€”"}</td>
        <td>${x.membership_name || "â€”"}</td>
        <td>${fixed}</td>
        <td>${fmtMoney(x.membership_amount)}â‚¾</td>
        <td>${fmtMoney(x.trainer_fee)}â‚¾</td>
        <td style="font-weight:900">${fmtMoney(x.amount)}â‚¾</td>
        <td>${x.method || "â€”"}</td>
      `;
      tb.appendChild(tr);
    });

    overlayPayHistory.classList.add("show");
  }

  $("mPayHistory").addEventListener("click", ()=>{
    if(!selectedClientId){
      toast(null,"áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜","áƒ¯áƒ”áƒ  áƒœáƒáƒ®áƒ•áƒ˜áƒ¡ áƒ›áƒáƒ“áƒáƒšáƒ˜ áƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ áƒáƒœ áƒªáƒ®áƒ áƒ˜áƒšáƒ˜áƒ“áƒáƒœ áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ”.");
      return;
    }
    openPayHistoryByClientId(selectedClientId);
  });

  // ===== top events
  $("btnSearch").addEventListener("click", ()=> applySearch());
  $("btnReset").addEventListener("click", ()=> { $("q").value=""; applySearch(); });
  $("btnExpiredList").addEventListener("click", ()=> { onlyExpiredMode = true; applySearch(); });
  $("btnRefresh").addEventListener("click", async ()=> {
    onlyExpiredMode = false;
    await loadClients();
    await loadPayments();
    await loadSummary();
  });
  $("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") applySearch(); });

  $("btnQuickCheckin").addEventListener("click", ()=>{
    const phone = ($("q").value || "").trim();
    if(phone && /^\d{6,}$/.test(phone)){
      doCheckinByPhone(phone);
      return;
    }
    if(!selectedClientId){
      toast(null, "áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜", "ğŸ‘ï¸ áƒœáƒáƒ®áƒ•áƒ áƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜ áƒáƒœ áƒ«áƒ”áƒ‘áƒœáƒáƒ¨áƒ˜ áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜ áƒ©áƒáƒ¬áƒ”áƒ áƒ”.");
      return;
    }
    doCheckinByClientId(selectedClientId);
  });

  $("btnNewClient").addEventListener("click", ()=> { window.location.href = "/clients/"; });
  $("btnNewPayment").addEventListener("click", ()=> { window.location.href = "/payments/"; });

  // init
  (async ()=>{
    await loadClients();
    await loadPayments();
    await loadSummary();
  })();
</script>
{% endblock %}
