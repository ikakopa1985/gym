{% extends "base.html" %}
{% block title %}áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ â€¢ Gym Manager{% endblock %}
{% block nav_payments_active %}active{% endblock %}

{% block extra_css %}
<style>
  .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:10px 14px;font-size:13px;}
  .kv label{color:var(--muted);font-weight:900}
  .input{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line2);background:var(--field-bg);color:var(--text);outline:0;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .tableWrap{margin-top:12px;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--field-bg);}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-weight:900;position:sticky;top:0;background:rgba(255,255,255,.03)}
  tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06)}
  tbody tr:hover{background:rgba(38,153,165,.08)}
  .tdActions{white-space:nowrap;display:flex;gap:8px;align-items:center}
  @media (max-width: 900px){ .kv{grid-template-columns:1fr} }

  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

  /* Details modal table */
  .modalTableWrap{
    margin-top:12px;
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    background: var(--field-bg);
    max-height: 320px;
    overflow:auto;
  }
  .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
</style>
{% endblock %}

{% block content %}
<div class="grid">

  <!-- Pay form -->
  <div class="card">
    <div class="head">
      <div>
        <h2>áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</h2>
        <div class="sub">áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ¡ áƒ˜áƒ áƒ©áƒ”áƒ• áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡áƒáƒ¡ áƒ“áƒ áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ Payment-áƒ–áƒ”</div>
      </div>
      <div class="row">
        <button class="btn" id="btnReload" type="button">ğŸ”„ áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ</button>
      </div>
    </div>

    <div class="body">
      <div class="kv">
        <label>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ *</label>
        <select class="input" id="p_client"></select>

        <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜ (áƒáƒ˜áƒ áƒ©áƒ˜áƒ”)</label>
        <select class="input" id="p_trainer"></select>

        <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ•áƒ™áƒ</label>
        <input class="input" id="p_trainer_fee" disabled>

        <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</label>
        <select class="input" id="p_membership"></select>

        <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ—áƒáƒœáƒ®áƒ</label>
        <input class="input" id="p_mem_amount" disabled>

        <label>áƒ¡áƒ£áƒš áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒ“áƒ”áƒšáƒ˜</label>
        <input class="input" id="p_total" disabled>

        <label>Fixed Start (áƒ—áƒ£ fixed)</label>
        <input class="input" id="p_fixed_start" type="date">

        <label>Fixed End (áƒ—áƒ£ fixed)</label>
        <input class="input" id="p_fixed_end" type="date">

        <label>áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜ *</label>
        <select class="input" id="p_method">
          <option value="cash">áƒ¥áƒ”áƒ¨áƒ˜</option>
          <option value="card">áƒ‘áƒáƒ áƒáƒ—áƒ˜</option>
          <option value="transfer">áƒ¢áƒ áƒáƒœáƒ¡áƒ¤áƒ”áƒ áƒ˜</option>
        </select>
      </div>

      <div style="margin-top:12px">
        <button class="btn primary" id="btnPay" type="button">ğŸ’³ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</button>
      </div>

      <div class="hint">
        áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ: áƒ—áƒ£ áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ¡ áƒáƒ  áƒáƒ˜áƒ áƒ©áƒ”áƒ•, áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ—áƒáƒœáƒ®áƒ áƒ˜áƒ¥áƒœáƒ”áƒ‘áƒ 0â‚¾.
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="card">
    <div class="head">
      <h2>áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ</h2>
      <div class="sub">áƒáƒ‘áƒáƒœ(â‚¾) + áƒ¢áƒ áƒ”áƒœ(â‚¾) = áƒ¡áƒ£áƒš(â‚¾) â€¢ â€áƒ“áƒáƒ¬áƒ•áƒ áƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ—â€œ áƒáƒ©áƒ•áƒ”áƒœáƒ”áƒ‘áƒ¡ áƒáƒ› áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ§áƒ•áƒ”áƒšáƒ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒáƒ¡</div>
    </div>
    <div class="body">
      <div class="tableWrap" style="max-height:520px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜</th>
              <th>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</th>
              <th>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜</th>
              <th>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</th>
              <th>áƒáƒ‘áƒáƒœ(â‚¾)</th>
              <th>áƒ¢áƒ áƒ”áƒœ(â‚¾)</th>
              <th>áƒ¡áƒ£áƒš(â‚¾)</th>
              <th>áƒ›áƒ”áƒ—áƒáƒ“áƒ˜</th>
              <th style="width:140px">áƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Details Modal -->
<div class="modalOverlay" id="overlayDetails">
  <div class="modal" style="max-width:980px;">
    <div class="mhead">
      <strong id="dTitle">áƒ“áƒáƒ¬áƒ•áƒ áƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ—</strong>
      <button class="closeX" id="dClose" type="button">âœ•</button>
    </div>

    <div class="mbody">
      <div class="kv" id="dKV"></div>

      <div class="divider"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:900">áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ</div>
          <div class="muted" style="font-size:12px;margin-top:2px" id="dSub">â€”</div>
        </div>

        <div class="muted" style="font-size:12px">
          áƒ¯áƒáƒ›áƒ˜: <span class="mono" id="dSum">0.00â‚¾</span>
        </div>
      </div>

      <div class="modalTableWrap">
        <table>
          <thead>
            <tr>
              <th>áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜</th>
              <th>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜</th>
              <th>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</th>
              <th>Fixed</th>
              <th>áƒáƒ‘áƒáƒœ(â‚¾)</th>
              <th>áƒ¢áƒ áƒ”áƒœ(â‚¾)</th>
              <th>áƒ¡áƒ£áƒš(â‚¾)</th>
              <th>áƒ›áƒ”áƒ—áƒáƒ“áƒ˜</th>
            </tr>
          </thead>
          <tbody id="dTbody"></tbody>
        </table>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn" id="dGoPayments" type="button">â†©ï¸ áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const $ = (id)=>document.getElementById(id);

  let clientsCache = [];
  let membershipsCache = [];
  let trainersCache = [];
  let paymentsCache = [];

  // ===== helpers
  function fmtMoney(v){
    const n = Number(v ?? 0);
    return Number.isFinite(n) ? n.toFixed(2) : "0.00";
  }

  function fmtDT(iso){
    if(!iso) return "â€”";
    return String(iso).slice(0,19).replace("T"," ");
  }

  function membershipPriceFromSelect(){
    const opt = $("p_membership").selectedOptions[0];
    return (opt && opt.dataset && opt.dataset.price) ? Number(opt.dataset.price) : 0;
  }

  function trainerFeeFromSelect(){
    const opt = $("p_trainer").selectedOptions[0];
    return (opt && opt.dataset && opt.dataset.fee) ? Number(opt.dataset.fee) : 0;
  }

  function updateTrainerFeeView(){
    const fee = trainerFeeFromSelect();
    $("p_trainer_fee").value = `${fmtMoney(fee)}â‚¾`;
  }

  function recalcTotals(){
    const mem = membershipPriceFromSelect();
    const fee = trainerFeeFromSelect();
    $("p_mem_amount").value = `${fmtMoney(mem)}â‚¾`;
    $("p_total").value = `${fmtMoney(mem + fee)}â‚¾`;
  }

  // ===== load data
  async function loadClients(){
    const res = await fetch("/api/clients/");
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    clientsCache = await res.json();
    $("p_client").innerHTML = clientsCache.map(c =>
      `<option value="${c.id}">${c.first_name} ${c.last_name} (${c.phone})</option>`
    ).join("");
  }

  async function loadTrainers(){
    const res = await fetch("/api/trainers/");
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    trainersCache = await res.json();

    $("p_trainer").innerHTML =
      `<option value="">â€” áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ’áƒáƒ áƒ”áƒ¨áƒ” â€”</option>` +
      trainersCache.map(t => `
        <option value="${t.id}" data-fee="${t.fee}">
          ${t.first_name} ${t.last_name} â€¢ ${fmtMoney(t.fee)}â‚¾
        </option>
      `).join("");
  }

  async function loadMemberships(){
    const res = await fetch("/api/memberships/");
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    membershipsCache = await res.json();

    $("p_membership").innerHTML =
      `<option value="">â€” áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ’áƒáƒ áƒ”áƒ¨áƒ” â€”</option>` +
      membershipsCache.map(m =>
        `<option value="${m.id}" data-price="${m.price}">
          ${m.name} â€¢ ${m.membership_type} â€¢ ${fmtMoney(m.price)}â‚¾
        </option>`
      ).join("");
  }

  // ===== history render
  function renderPayments(items){
    paymentsCache = Array.isArray(items) ? items.slice() : [];

    const tb = $("tbody");
    tb.innerHTML = "";

    paymentsCache.forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtDT(p.created_at)}</td>
        <td>${p.client_name || "â€”"}</td>
        <td>${p.trainer_name || "â€”"}</td>
        <td>${p.membership_name || "â€”"}</td>
        <td>${fmtMoney(p.membership_amount)}â‚¾</td>
        <td>${fmtMoney(p.trainer_fee)}â‚¾</td>
        <td style="font-weight:900">${fmtMoney(p.amount)}â‚¾</td>
        <td>${p.method || "â€”"}</td>
        <td>
          <div class="tdActions">
            <button class="btn" data-details="${p.id}" type="button">áƒ“áƒáƒ¬áƒ•áƒ áƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ—</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-details]").forEach(btn=>{
      btn.addEventListener("click", ()=> openDetailsModal(Number(btn.dataset.details)));
    });
  }

  async function loadPayments(){
    const res = await fetch("/api/payments/");
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    const data = await res.json();
    renderPayments(data);
  }

  // ===== Details modal
  const overlayDetails = $("overlayDetails");

  function closeDetails(){
    overlayDetails.classList.remove("show");
  }

  function openDetailsModal(paymentId){
    const p = paymentsCache.find(x => Number(x.id) === Number(paymentId));
    if(!p){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒáƒáƒ•áƒœáƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ");
      return;
    }

    // PaymentSerializer-áƒ¨áƒ˜ áƒ’áƒ•áƒáƒ¥áƒ•áƒ¡ client id field ("client")
    const clientId = p.client;  // IMPORTANT: serializer fields-áƒ¨áƒ˜ "client" áƒ’áƒáƒ¥áƒ•áƒ¡
    const clientName = p.client_name || "â€”";

    $("dTitle").textContent = `áƒ“áƒáƒ¬áƒ•áƒ áƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ— â€¢ ${clientName}`;
    $("dKV").innerHTML = `
      <label>Payment ID</label><div class="mono">${p.id}</div>
      <label>áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜</label><div>${fmtDT(p.created_at)}</div>
      <label>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</label><div>${clientName}</div>
      <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜</label><div>${p.trainer_name || "â€”"}</div>
      <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</label><div>${p.membership_name || "â€”"}</div>
      <label>Fixed Start</label><div>${p.fixed_start || "â€”"}</div>
      <label>Fixed End</label><div>${p.fixed_end || "â€”"}</div>
      <label>áƒ›áƒ”áƒ—áƒáƒ“áƒ˜</label><div>${p.method || "â€”"}</div>
      <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜ (â‚¾)</label><div style="font-weight:900">${fmtMoney(p.membership_amount)}â‚¾</div>
      <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜ (â‚¾)</label><div style="font-weight:900">${fmtMoney(p.trainer_fee)}â‚¾</div>
      <label>áƒ¡áƒ£áƒš (â‚¾)</label><div style="font-weight:900">${fmtMoney(p.amount)}â‚¾</div>
    `;

    // Client payments history (filter)
    const list = paymentsCache
      .filter(x => String(x.client) === String(clientId))
      .sort((a,b)=> Number(b.id) - Number(a.id));

    $("dSub").textContent = `áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜: ${clientName} â€¢ áƒ©áƒáƒœáƒáƒ¬áƒ”áƒ áƒ”áƒ‘áƒ˜: ${list.length}`;

    const sum = list.reduce((acc, x)=> acc + Number(x.amount || 0), 0);
    $("dSum").textContent = `${fmtMoney(sum)}â‚¾`;

    const dTb = $("dTbody");
    dTb.innerHTML = "";
    list.forEach(x=>{
      const fixed = (x.fixed_start || x.fixed_end) ? `${x.fixed_start || "â€”"} â†’ ${x.fixed_end || "â€”"}` : "â€”";
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${fmtDT(x.created_at)}</td>
        <td>${x.trainer_name || "â€”"}</td>
        <td>${x.membership_name || "â€”"}</td>
        <td>${fixed}</td>
        <td>${fmtMoney(x.membership_amount)}â‚¾</td>
        <td>${fmtMoney(x.trainer_fee)}â‚¾</td>
        <td style="font-weight:900">${fmtMoney(x.amount)}â‚¾</td>
        <td>${x.method || "â€”"}</td>
      `;
      dTb.appendChild(row);
    });

    overlayDetails.classList.add("show");
  }

  $("dClose").addEventListener("click", closeDetails);
  overlayDetails.addEventListener("click", (e)=>{ if(e.target===overlayDetails) closeDetails(); });
  $("dGoPayments").addEventListener("click", closeDetails);

  // ===== events
  $("p_membership").addEventListener("change", recalcTotals);
  $("p_trainer").addEventListener("change", ()=>{
    updateTrainerFeeView();
    recalcTotals();
  });

  $("btnPay").addEventListener("click", async ()=>{
    const client = $("p_client").value;
    const membership = $("p_membership").value || null;
    const trainer = $("p_trainer").value || null;
    const method = $("p_method").value;

    if(!client || !method){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”: áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ áƒ“áƒ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜");
      return;
    }

    const payload = {
      client: Number(client),
      membership: membership ? Number(membership) : null,
      trainer: trainer ? Number(trainer) : null,
      method: method,
      fixed_start: $("p_fixed_start").value || null,
      fixed_end: $("p_fixed_end").value || null,
    };

    const res = await fetch("/api/payments/", {
      method:"POST",
      headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
      body: JSON.stringify(payload)
    });

    let data = {};
    try{ data = await res.json(); }catch(e){}

    if(!res.ok){
      toast("bad","áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ", data.detail || JSON.stringify(data));
      return;
    }

    toast(
      "ok",
      "OK",
      `áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ âœ… áƒ¡áƒ£áƒš: ${fmtMoney(data.amount)}â‚¾ (áƒáƒ‘áƒáƒœ: ${fmtMoney(data.membership_amount)}â‚¾ + áƒ¢áƒ áƒ”áƒœ: ${fmtMoney(data.trainer_fee)}â‚¾)`
    );

    $("p_fixed_start").value = "";
    $("p_fixed_end").value = "";
    $("p_membership").value = "";
    $("p_trainer").value = "";
    updateTrainerFeeView();
    recalcTotals();

    await loadPayments();
  });

  $("btnReload").addEventListener("click", async ()=>{
    await loadClients();
    await loadTrainers();
    await loadMemberships();
    await loadPayments();
    updateTrainerFeeView();
    recalcTotals();
    toast("ok","OK","áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ");
  });

  // init
  (async ()=>{
    await loadClients();
    await loadTrainers();
    await loadMemberships();
    await loadPayments();
    updateTrainerFeeView();
    recalcTotals();
  })();
</script>
{% endblock %}
