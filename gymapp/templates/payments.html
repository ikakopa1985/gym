{% extends "base.html" %}
{% block title %}áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ â€¢ Gym Manager{% endblock %}
{% block nav_payments_active %}active{% endblock %}

{% block extra_css %}
<style>
  .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:10px 14px;font-size:13px;}
  .kv label{color:var(--muted);font-weight:900}
  .input{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line2);background:var(--field-bg);color:var(--text);outline:0;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .tableWrap{margin-top:12px;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--field-bg);}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-weight:900;position:sticky;top:0;background:rgba(255,255,255,.03)}
  tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06)}
  tbody tr:hover{background:rgba(38,153,165,.08)}
  .tdActions{white-space:nowrap;display:flex;gap:8px;align-items:center}
  @media (max-width: 900px){ .kv{grid-template-columns:1fr} }

  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
</style>
{% endblock %}

{% block content %}
<div class="grid">

  <!-- Pay form -->
  <div class="card">
    <div class="head">
      <div>
        <h2>áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</h2>
        <div class="sub">áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ¡ áƒ˜áƒ áƒ©áƒ”áƒ• áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡áƒáƒ¡ áƒ“áƒ áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ Payment-áƒ–áƒ”</div>
      </div>
      <div class="row">
        <button class="btn" id="btnReload" type="button">ğŸ”„ áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ</button>
      </div>
    </div>

    <div class="body">
      <div class="kv">
        <label>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ *</label>
        <select class="input" id="p_client"></select>

        <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜ (áƒáƒ˜áƒ áƒ©áƒ˜áƒ”)</label>
        <select class="input" id="p_trainer"></select>

        <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ•áƒ™áƒ</label>
        <input class="input" id="p_trainer_fee" disabled>

        <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</label>
        <select class="input" id="p_membership"></select>

        <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ—áƒáƒœáƒ®áƒ</label>
        <input class="input" id="p_mem_amount" disabled>

        <label>áƒ¡áƒ£áƒš áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒ“áƒ”áƒšáƒ˜</label>
        <input class="input" id="p_total" disabled>

        <label>Fixed Start (áƒ—áƒ£ fixed)</label>
        <input class="input" id="p_fixed_start" type="date">

        <label>Fixed End (áƒ—áƒ£ fixed)</label>
        <input class="input" id="p_fixed_end" type="date">

        <label>áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜ *</label>
        <select class="input" id="p_method">
          <option value="cash">áƒ¥áƒ”áƒ¨áƒ˜</option>
          <option value="card">áƒ‘áƒáƒ áƒáƒ—áƒ˜</option>
          <option value="transfer">áƒ¢áƒ áƒáƒœáƒ¡áƒ¤áƒ”áƒ áƒ˜</option>
        </select>
      </div>

      <div style="margin-top:12px">
        <button class="btn primary" id="btnPay" type="button">ğŸ’³ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</button>
      </div>

      <div class="hint">
        áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ: áƒ—áƒ£ áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ¡ áƒáƒ  áƒáƒ˜áƒ áƒ©áƒ”áƒ•, áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ—áƒáƒœáƒ®áƒ áƒ˜áƒ¥áƒœáƒ”áƒ‘áƒ 0â‚¾.
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="card">
    <div class="head">
      <h2>áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ</h2>
      <div class="sub">áƒáƒ‘áƒáƒœ(â‚¾) + áƒ¢áƒ áƒ”áƒœ(â‚¾) = áƒ¡áƒ£áƒš(â‚¾)</div>
    </div>
    <div class="body">
      <div class="tableWrap" style="max-height:520px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜</th>
              <th>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</th>
              <th>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜</th>
              <th>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</th>
              <th>áƒáƒ‘áƒáƒœ(â‚¾)</th>
              <th>áƒ¢áƒ áƒ”áƒœ(â‚¾)</th>
              <th>áƒ¡áƒ£áƒš(â‚¾)</th>
              <th>áƒ›áƒ”áƒ—áƒáƒ“áƒ˜</th>
              <th style="width:170px">áƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Edit Modal -->
<div class="modalOverlay" id="overlayEdit">
  <div class="modal" style="max-width:860px;">
    <div class="mhead">
      <strong id="eTitle">áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ</strong>
      <button class="closeX" id="eClose" type="button">âœ•</button>
    </div>

    <div class="mbody">
      <div class="kv">
        <label>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ *</label>
        <select class="input" id="e_client"></select>

        <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜</label>
        <select class="input" id="e_trainer"></select>

        <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ•áƒ™áƒ</label>
        <input class="input" id="e_trainer_fee" disabled>

        <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</label>
        <select class="input" id="e_membership"></select>

        <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ—áƒáƒœáƒ®áƒ</label>
        <input class="input" id="e_mem_amount" disabled>

        <label>áƒ¡áƒ£áƒš áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒ“áƒ”áƒšáƒ˜</label>
        <input class="input" id="e_total" disabled>

        <label>Fixed Start</label>
        <input class="input" id="e_fixed_start" type="date">

        <label>Fixed End</label>
        <input class="input" id="e_fixed_end" type="date">

        <label>áƒ›áƒ”áƒ—áƒáƒ“áƒ˜ *</label>
        <select class="input" id="e_method">
          <option value="cash">áƒ¥áƒ”áƒ¨áƒ˜</option>
          <option value="card">áƒ‘áƒáƒ áƒáƒ—áƒ˜</option>
          <option value="transfer">áƒ¢áƒ áƒáƒœáƒ¡áƒ¤áƒ”áƒ áƒ˜</option>
        </select>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn primary" id="btnSaveEdit" type="button">ğŸ’¾ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        <button class="btn" id="btnCancelEdit" type="button">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
      </div>

      <div class="hint">Edit-áƒ¨áƒ˜ â€œáƒ¡áƒ£áƒšâ€ áƒ˜áƒ—áƒ•áƒšáƒ”áƒ‘áƒ: membership price + trainer fee (áƒ‘áƒ”áƒ¥áƒ˜áƒª áƒ’áƒáƒ“áƒáƒáƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ¡).</div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const $ = (id)=>document.getElementById(id);

  let clientsCache = [];
  let membershipsCache = [];
  let trainersCache = [];
  let paymentsCache = [];

  let editingId = null;

  // ===== helpers
  function fmtMoney(v){
    const n = Number(v ?? 0);
    return Number.isFinite(n) ? n.toFixed(2) : "0.00";
  }
  function fmtDT(iso){
    if(!iso) return "â€”";
    return String(iso).slice(0,19).replace("T"," ");
  }

  function getOptPrice(selectId){
    const opt = $(selectId).selectedOptions[0];
    return (opt && opt.dataset && opt.dataset.price) ? Number(opt.dataset.price) : 0;
  }
  function getOptFee(selectId){
    const opt = $(selectId).selectedOptions[0];
    return (opt && opt.dataset && opt.dataset.fee) ? Number(opt.dataset.fee) : 0;
  }

  function recalc(prefix){
    const mem = getOptPrice(prefix+"_membership");
    const fee = getOptFee(prefix+"_trainer");
    $(prefix+"_mem_amount").value = `${fmtMoney(mem)}â‚¾`;
    $(prefix+"_trainer_fee").value = `${fmtMoney(fee)}â‚¾`;
    $(prefix+"_total").value = `${fmtMoney(mem + fee)}â‚¾`;
  }

  // ===== load data
  async function loadClients(){
    const res = await fetch("/api/clients/");
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    clientsCache = await res.json();

    const options = clientsCache.map(c =>
      `<option value="${c.id}">${c.first_name} ${c.last_name} (${c.phone})</option>`
    ).join("");

    $("p_client").innerHTML = options;
    $("e_client").innerHTML = options;
  }

  async function loadTrainers(){
    const res = await fetch("/api/trainers/");
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    trainersCache = await res.json();

    const opts =
      `<option value="">â€” áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜áƒ¡ áƒ’áƒáƒ áƒ”áƒ¨áƒ” â€”</option>` +
      trainersCache.map(t => `
        <option value="${t.id}" data-fee="${t.fee}">
          ${t.first_name} ${t.last_name} â€¢ ${fmtMoney(t.fee)}â‚¾
        </option>
      `).join("");

    $("p_trainer").innerHTML = opts;
    $("e_trainer").innerHTML = opts;
  }

  async function loadMemberships(){
    const res = await fetch("/api/memberships/");
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    membershipsCache = await res.json();

    const opts =
      `<option value="">â€” áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ’áƒáƒ áƒ”áƒ¨áƒ” â€”</option>` +
      membershipsCache.map(m =>
        `<option value="${m.id}" data-price="${m.price}">
          ${m.name} â€¢ ${m.membership_type} â€¢ ${fmtMoney(m.price)}â‚¾
        </option>`
      ).join("");

    $("p_membership").innerHTML = opts;
    $("e_membership").innerHTML = opts;
  }

  // ===== history render
  function renderPayments(items){
    paymentsCache = Array.isArray(items) ? items.slice() : [];
    const tb = $("tbody");
    tb.innerHTML = "";

    paymentsCache.forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtDT(p.created_at)}</td>
        <td>${p.client_name || "â€”"}</td>
        <td>${p.trainer_name || "â€”"}</td>
        <td>${p.membership_name || "â€”"}</td>
        <td>${fmtMoney(p.membership_amount)}â‚¾</td>
        <td>${fmtMoney(p.trainer_fee)}â‚¾</td>
        <td style="font-weight:900">${fmtMoney(p.amount)}â‚¾</td>
        <td>${p.method || "â€”"}</td>
        <td>
          <div class="tdActions">
            <button class="btn" data-edit="${p.id}" type="button">âœï¸ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ</button>
            <button class="btn danger" data-del="${p.id}" type="button">ğŸ—‘ï¸ áƒ¬áƒáƒ¨áƒšáƒ</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=> openEdit(Number(btn.dataset.edit)));
    });
    tb.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=> deletePayment(Number(btn.dataset.del)));
    });
  }

  async function loadPayments(){
    const res = await fetch("/api/payments/");
    if(!res.ok){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ"); return; }
    const data = await res.json();
    renderPayments(data);
  }

  // ===== create payment
  $("p_membership").addEventListener("change", ()=>recalc("p"));
  $("p_trainer").addEventListener("change", ()=>recalc("p"));

  $("btnPay").addEventListener("click", async ()=>{
    const client = $("p_client").value;
    const membership = $("p_membership").value || null;
    const trainer = $("p_trainer").value || null;
    const method = $("p_method").value;

    if(!client || !method){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”: áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ áƒ“áƒ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜");
      return;
    }

    const payload = {
      client: Number(client),
      membership: membership ? Number(membership) : null,
      trainer: trainer ? Number(trainer) : null,
      method: method,
      fixed_start: $("p_fixed_start").value || null,
      fixed_end: $("p_fixed_end").value || null,
    };

    const res = await fetch("/api/payments/", {
      method:"POST",
      headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
      body: JSON.stringify(payload)
    });

    let data = {};
    try{ data = await res.json(); }catch(e){}

    if(!res.ok){
      toast("bad","áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ", data.detail || JSON.stringify(data));
      return;
    }

    toast("ok","OK",`áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ âœ… áƒ¡áƒ£áƒš: ${fmtMoney(data.amount)}â‚¾`);
    $("p_fixed_start").value = "";
    $("p_fixed_end").value = "";
    $("p_membership").value = "";
    $("p_trainer").value = "";
    recalc("p");
    await loadPayments();
  });

  // ===== edit modal
  const overlayEdit = $("overlayEdit");

  function openEdit(id){
    const p = paymentsCache.find(x => Number(x.id) === Number(id));
    if(!p){ toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ©áƒáƒœáƒáƒ¬áƒ”áƒ áƒ˜ áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ"); return; }

    editingId = id;
    $("eTitle").textContent = `áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ â€¢ Payment #${id}`;

    $("e_client").value = String(p.client || "");
    $("e_trainer").value = (p.trainer === null || p.trainer === undefined) ? "" : String(p.trainer);
    $("e_membership").value = (p.membership === null || p.membership === undefined) ? "" : String(p.membership);

    $("e_fixed_start").value = p.fixed_start || "";
    $("e_fixed_end").value = p.fixed_end || "";
    $("e_method").value = p.method || "cash";

    recalc("e");
    overlayEdit.classList.add("show");
  }

  function closeEdit(){
    overlayEdit.classList.remove("show");
    editingId = null;
  }

  $("eClose").addEventListener("click", closeEdit);
  $("btnCancelEdit").addEventListener("click", closeEdit);
  overlayEdit.addEventListener("click", (e)=>{ if(e.target===overlayEdit) closeEdit(); });

  $("e_membership").addEventListener("change", ()=>recalc("e"));
  $("e_trainer").addEventListener("change", ()=>recalc("e"));

  $("btnSaveEdit").addEventListener("click", async ()=>{
    if(!editingId){ return; }

    const client = $("e_client").value;
    const membership = $("e_membership").value || null;
    const trainer = $("e_trainer").value || null;
    const method = $("e_method").value;

    if(!client || !method){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”: áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ áƒ“áƒ áƒ›áƒ”áƒ—áƒáƒ“áƒ˜");
      return;
    }

    const payload = {
      client: Number(client),
      membership: membership ? Number(membership) : null,
      trainer: trainer ? Number(trainer) : null,
      method: method,
      fixed_start: $("e_fixed_start").value || null,
      fixed_end: $("e_fixed_end").value || null,
    };

    const res = await fetch(`/api/payments/${editingId}/`, {
      method:"PUT",
      headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
      body: JSON.stringify(payload)
    });

    let data = {};
    try{ data = await res.json(); }catch(e){}

    if(!res.ok){
      toast("bad","áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ˜áƒœáƒáƒ®áƒ", data.detail || JSON.stringify(data));
      return;
    }

    toast("ok","OK",`áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ âœ… áƒ¡áƒ£áƒš: ${fmtMoney(data.amount)}â‚¾`);
    closeEdit();
    await loadPayments();
  });

  // ===== delete
  async function deletePayment(id){
    const p = paymentsCache.find(x => Number(x.id) === Number(id));
    const label = p ? `${p.client_name || ""} â€¢ ${fmtMoney(p.amount)}â‚¾` : `Payment #${id}`;

    if(!confirm(`áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ  áƒ áƒáƒ› áƒ¬áƒáƒ¨áƒáƒšáƒ?\n${label}`)) return;

    const res = await fetch(`/api/payments/${id}/`, {
      method:"DELETE",
      headers: {"X-CSRFToken": csrftoken}
    });

    if(!res.ok){
      let err = {};
      try{ err = await res.json(); }catch(e){}
      toast("bad","áƒ•áƒ”áƒ  áƒ¬áƒáƒ˜áƒ¨áƒáƒšáƒ", err.detail || JSON.stringify(err) || "áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ");
      return;
    }

    toast("ok","OK","áƒ¬áƒáƒ˜áƒ¨áƒáƒšáƒ âœ…");
    await loadPayments();
  }

  // ===== reload
  $("btnReload").addEventListener("click", async ()=>{
    await loadClients();
    await loadTrainers();
    await loadMemberships();
    await loadPayments();
    recalc("p");
    toast("ok","OK","áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ");
  });

  // init
  (async ()=>{
    await loadClients();
    await loadTrainers();
    await loadMemberships();
    await loadPayments();
    recalc("p");
  })();
</script>
{% endblock %}
