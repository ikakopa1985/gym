{% extends "base.html" %}

{% block title %}áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ â€¢ Gym Manager{% endblock %}
{% block subtitle %}áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ{% endblock %}
{% block nav_clients_active %}active{% endblock %}

{% block extra_css %}
<style>
  .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  .tableWrap{
    margin-top:12px;
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
    background: var(--field-bg);
  }

  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{
    text-align:left;
    padding:12px 12px;
    font-weight:900;
    background: rgba(255,255,255,.03);
    border-bottom:1px solid var(--line);
    position:sticky; top:0;
  }
  tbody td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
  tbody tr:hover{background: rgba(38,153,165,.08)}

  .avatar{
    width:38px;height:38px;border-radius:14px;object-fit:cover;
    border:1px solid var(--line2);
    background: rgba(255,255,255,.06);
  }

  .kv{
    display:grid;
    grid-template-columns: 160px 1fr;
    gap:10px 12px;
    font-size:13px;
  }
  .kv label{color:var(--muted);font-weight:900}

  .input{
    width:100%;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line2);
    background: var(--field-bg);
    color:var(--text);
    outline:0;
  }
  .select{appearance:none}

  .hint{font-size:12px;color:var(--muted);margin-top:8px}

  /* modal body spacing */
  .mbody .kv{grid-template-columns:180px 1fr}
  @media (max-width: 760px){
    .kv{grid-template-columns:1fr}
    .mbody .kv{grid-template-columns:1fr}
  }
</style>
{% endblock %}

{% block content %}
<div class="grid">
  <div class="card">
    <div class="head">
      <div>
        <h2>áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ˜áƒ</h2>
        <div class="sub">áƒ«áƒ”áƒ‘áƒœáƒ áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜áƒ—/áƒ¡áƒáƒ®áƒ”áƒšáƒ˜áƒ—/áƒ’áƒ•áƒáƒ áƒ˜áƒ—/áƒ‘áƒáƒ áƒáƒ—áƒ˜áƒ¡ áƒœáƒáƒ›áƒ áƒ˜áƒ—</div>
      </div>
      <div class="row">
        <span class="pill" id="countPill">0 áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</span>
        <button class="btn primary" id="btnOpenNew" type="button">+ áƒáƒ®áƒáƒšáƒ˜ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</button>
      </div>
    </div>

    <div class="body">
      <div class="row">
        <div class="field" style="flex:1;min-width:260px;">
          <span>ğŸ”</span>
          <input id="q" placeholder="áƒ›áƒáƒ’: 555... / áƒ’áƒ˜áƒáƒ áƒ’áƒ˜ / CARD-001" autocomplete="off">
        </div>
        <button class="btn primary" id="btnSearch" type="button">áƒ«áƒ”áƒ‘áƒœáƒ</button>
        <button class="btn" id="btnReset" type="button">áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</button>
      </div>
      <div class="hint">áƒ¤áƒáƒ¢áƒáƒ¡ áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡ multipart/form-data-áƒ˜áƒ—.</div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:34%">áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</th>
              <th style="width:18%">áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜</th>
              <th style="width:18%">áƒ”áƒš. áƒ¤áƒáƒ¡áƒ¢áƒ</th>
              <th style="width:20%">áƒáƒ áƒ’áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ</th>
              <th style="width:10%">áƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- New Client Modal -->
<div class="modalOverlay" id="overlayNew">
  <div class="modal">
    <div class="mhead">
      <strong>áƒáƒ®áƒáƒšáƒ˜ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</strong>
      <button class="closeX" id="closeNew" type="button">âœ•</button>
    </div>
    <div class="mbody">
      <div class="kv">
        <label>áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ *</label>
        <input class="input" id="c_first" placeholder="áƒ’áƒ˜áƒáƒ áƒ’áƒ˜">

        <label>áƒ’áƒ•áƒáƒ áƒ˜ *</label>
        <input class="input" id="c_last" placeholder="áƒ™áƒáƒáƒáƒœáƒáƒ«áƒ”">

        <label>áƒ“áƒáƒ‘. áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜</label>
        <input class="input" id="c_birth" type="date">

        <label>áƒ¡áƒ¥áƒ”áƒ¡áƒ˜</label>
        <select class="input select" id="c_gender">
          <option value="">â€”</option>
          <option value="male">áƒ›áƒáƒ›áƒ áƒáƒ‘áƒ˜áƒ—áƒ˜</option>
          <option value="female">áƒ›áƒ“áƒ”áƒ“áƒ áƒáƒ‘áƒ˜áƒ—áƒ˜</option>
          <option value="other">áƒ¡áƒ®áƒ•áƒ</option>
        </select>

        <label>áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜ *</label>
        <input class="input" id="c_phone" placeholder="555123456">

        <label>áƒ”áƒš. áƒ¤áƒáƒ¡áƒ¢áƒ</label>
        <input class="input" id="c_email" type="email" placeholder="name@mail.com">

        <label>áƒáƒ áƒ’áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ</label>
        <input class="input" id="c_org" placeholder="Company / Organization">

        <label>áƒ‘áƒáƒ áƒáƒ—áƒ˜áƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ˜</label>
        <input class="input" id="c_card" placeholder="CARD-001">

        <label>áƒ¤áƒáƒ¢áƒáƒ¡áƒ£áƒ áƒáƒ—áƒ˜</label>
        <input class="input" id="c_photo" type="file" accept="image/*">
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn primary" id="btnSave" type="button">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        <button class="btn" id="btnCancel" type="button">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
      </div>
    </div>
  </div>
</div>

<!-- View Modal -->
<div class="modalOverlay" id="overlayView">
  <div class="modal">
    <div class="mhead">
      <strong id="vTitle">áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜</strong>
      <button class="closeX" id="closeView" type="button">âœ•</button>
    </div>
    <div class="mbody" id="vBody"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const $ = (id)=>document.getElementById(id);

  const overlayNew = $("overlayNew");
  const overlayView = $("overlayView");

  function openNew(){ overlayNew.classList.add("show"); }
  function closeNew(){ overlayNew.classList.remove("show"); }
  function openView(){ overlayView.classList.add("show"); }
  function closeView(){ overlayView.classList.remove("show"); }

  $("btnOpenNew").addEventListener("click", openNew);
  $("closeNew").addEventListener("click", closeNew);
  $("btnCancel").addEventListener("click", closeNew);
  overlayNew.addEventListener("click", (e)=>{ if(e.target===overlayNew) closeNew(); });

  $("closeView").addEventListener("click", closeView);
  overlayView.addEventListener("click", (e)=>{ if(e.target===overlayView) closeView(); });

  function genderLabel(g){
    if(g === "male") return "áƒ›áƒáƒ›áƒ áƒáƒ‘áƒ˜áƒ—áƒ˜";
    if(g === "female") return "áƒ›áƒ“áƒ”áƒ“áƒ áƒáƒ‘áƒ˜áƒ—áƒ˜";
    if(g === "other") return "áƒ¡áƒ®áƒ•áƒ";
    return "â€”";
  }

  function photoUrl(v){
    if(!v) return null;
    // áƒ—áƒ£ backend áƒáƒ‘áƒ áƒ£áƒœáƒ”áƒ‘áƒ¡ absolute URL-áƒ¡ áƒáƒœ relative-áƒ¡, áƒáƒ áƒ˜áƒ•áƒ” áƒ˜áƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ¡
    if(String(v).startsWith("http://") || String(v).startsWith("https://")) return v;
    if(String(v).startsWith("/")) return v;
    return "/" + v;
  }

  function avatarHtml(photo){
    const u = photoUrl(photo);
    if(u) return `<img class="avatar" src="${u}" alt="photo">`;
    return `<div class="avatar" style="display:grid;place-items:center;font-weight:900;">ğŸ‘¤</div>`;
  }

  let lastLoaded = []; // fallback filter-áƒ¡áƒ—áƒ•áƒ˜áƒ¡

  function renderRows(items){
    lastLoaded = items || [];
    const tbody = $("tbody");
    tbody.innerHTML = "";
    $("countPill").textContent = `${(items||[]).length} áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜`;

    for(const c of (items||[])){
      const full = `${c.first_name || ""} ${c.last_name || ""}`.trim();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="display:flex;align-items:center;gap:10px;">
            ${avatarHtml(c.photo)}
            <div>
              <div style="font-weight:900">${full || "â€”"}</div>
              <div class="muted" style="font-size:12px;margin-top:3px;">
                áƒ‘áƒáƒ áƒáƒ—áƒ˜: ${c.card_number || "â€”"} â€¢ áƒ¡áƒ¥áƒ”áƒ¡áƒ˜: ${genderLabel(c.gender)} â€¢ áƒ“áƒáƒ‘: ${c.birth_date || "â€”"}
              </div>
            </div>
          </div>
        </td>
        <td>${c.phone || "â€”"}</td>
        <td>${c.email || "â€”"}</td>
        <td>${c.organization || "â€”"}</td>
        <td>
          <button class="btn" data-view="${c.id}" type="button">ğŸ‘ï¸ áƒœáƒáƒ®áƒ•áƒ</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=> viewClient(Number(btn.getAttribute("data-view"))));
    });
  }

  function localFilter(q){
    q = (q||"").trim().toLowerCase();
    if(!q) return lastLoaded;
    return (lastLoaded||[]).filter(c=>{
      const full = (`${c.first_name||""} ${c.last_name||""}`).toLowerCase();
      const phone = (c.phone||"").toLowerCase();
      const card = (c.card_number||"").toLowerCase();
      return full.includes(q) || phone.includes(q) || card.includes(q);
    });
  }

  async function loadClients(q=""){
    // 1) áƒáƒ˜áƒ áƒ•áƒ”áƒš áƒ áƒ˜áƒ’áƒ¨áƒ˜ áƒ•áƒªáƒáƒ“áƒáƒ— backend search
    const url = q ? `/api/clients/?search=${encodeURIComponent(q)}` : "/api/clients/";
    let res = await fetch(url);

    // 2) áƒ—áƒ£ search áƒáƒ  áƒ’áƒ˜áƒ­áƒ”áƒ áƒ¡ backend-áƒ–áƒ” -> áƒ©áƒáƒ›áƒáƒ•áƒ˜áƒ¢áƒáƒœáƒáƒ— áƒ§áƒ•áƒ”áƒšáƒ áƒ“áƒ frontend-áƒ–áƒ” áƒ’áƒáƒ•áƒ¤áƒ˜áƒšáƒ¢áƒ áƒáƒ—
    if(!res.ok && q){
      res = await fetch("/api/clients/");
      if(!res.ok){
        toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ›áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
        return;
      }
      const all = await res.json();
      renderRows(all);
      renderRows(localFilter(q));
      return;
    }

    if(!res.ok){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ›áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
      return;
    }

    const data = await res.json();
    renderRows(data);
  }

  async function viewClient(id){
    const res = await fetch(`/api/clients/${id}/`);
    if(!res.ok){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ’áƒáƒ®áƒ¡áƒœáƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
      return;
    }
    const c = await res.json();
    const full = `${c.first_name || ""} ${c.last_name || ""}`.trim();

    $("vTitle").textContent = full || "áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜";
    $("vBody").innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
        ${avatarHtml(c.photo)}
        <div>
          <div style="font-weight:900;font-size:16px;">${full || "â€”"}</div>
          <div class="muted" style="margin-top:4px;">${c.phone || "â€”"} â€¢ ${c.email || "â€”"}</div>
        </div>
      </div>

      <div class="kv">
        <label>áƒ“áƒáƒ‘. áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜</label><div>${c.birth_date || "â€”"}</div>
        <label>áƒ¡áƒ¥áƒ”áƒ¡áƒ˜</label><div>${genderLabel(c.gender)}</div>
        <label>áƒáƒ áƒ’áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ</label><div>${c.organization || "â€”"}</div>
        <label>áƒ‘áƒáƒ áƒáƒ—áƒ˜áƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ˜</label><div>${c.card_number || "â€”"}</div>
        <label>áƒ¢áƒ áƒ”áƒœáƒ”áƒ áƒ˜</label><div>${c.trainer_name || "â€”"}</div>
        <label>áƒáƒ‘áƒáƒœáƒ”áƒ›áƒ”áƒœáƒ¢áƒ˜</label><div>${c.active_membership_name || "â€”"}</div>
        <label>áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</label><div>${(c.is_active === true) ? "áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜áƒ" : ((c.is_active === false) ? "áƒ•áƒáƒ“áƒáƒ’áƒáƒ¡áƒ£áƒšáƒ˜áƒ" : "â€”")}</div>
      </div>
    `;
    openView();
  }

  $("btnSearch").addEventListener("click", ()=> loadClients($("q").value));
  $("btnReset").addEventListener("click", ()=> { $("q").value=""; loadClients(""); });
  $("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadClients($("q").value); });

  $("btnSave").addEventListener("click", async ()=>{
    const first_name = $("c_first").value.trim();
    const last_name  = $("c_last").value.trim();
    const phone      = $("c_phone").value.trim();

    if(!first_name || !last_name || !phone){
      toast("bad","áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ","áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”: áƒ¡áƒáƒ®áƒ”áƒšáƒ˜, áƒ’áƒ•áƒáƒ áƒ˜, áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜.");
      return;
    }

    const fd = new FormData();
    fd.append("first_name", first_name);
    fd.append("last_name", last_name);
    fd.append("phone", phone);

    const birth = $("c_birth").value;
    const gender = $("c_gender").value;
    const email = $("c_email").value.trim();
    const org = $("c_org").value.trim();
    const card = $("c_card").value.trim();
    const photo = $("c_photo").files[0];

    if(birth) fd.append("birth_date", birth);
    if(gender) fd.append("gender", gender);
    if(email) fd.append("email", email);
    if(org) fd.append("organization", org);
    if(card) fd.append("card_number", card);
    if(photo) fd.append("photo", photo);

    const res = await fetch("/api/clients/", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: fd
    });

    if(!res.ok){
      let err = {};
      try{ err = await res.json(); }catch(e){}
      // DRF validation dict áƒ®áƒ¨áƒ˜áƒ áƒáƒ“ {"field":["..."]} áƒ›áƒáƒ“áƒ˜áƒ¡
      const msg = err.detail
        || (err.card_number && err.card_number[0])
        || (err.phone && err.phone[0])
        || JSON.stringify(err)
        || "áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ” áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜.";
      toast("bad","áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ˜áƒœáƒáƒ®áƒ", msg);
      return;
    }

    toast("ok","áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ","áƒáƒ®áƒáƒšáƒ˜ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜ áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ âœ…");
    closeNew();

    ["c_first","c_last","c_phone","c_email","c_org","c_card"].forEach(id=>$(id).value="");
    $("c_birth").value="";
    $("c_gender").value="";
    $("c_photo").value="";

    await loadClients($("q").value.trim());
  });

  // init
  loadClients("");
</script>
{% endblock %}
